name: CI

on:
  push:
  pull_request:

jobs:
  # ══════════════════════════════════════════════════════════════════════════════
  # BACKEND
  # ══════════════════════════════════════════════════════════════════════════════

  backend-test:
    name: Backend — Unit Tests (Jest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests with coverage
        run: npm test

  backend-lint:
    name: Backend — Code Style (ESLint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Check code style
        run: npm run lint

  backend-quality:
    name: Backend — Code Quality (SonarJS)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Analyze code quality
        run: npm run lint:quality

  # ══════════════════════════════════════════════════════════════════════════════
  # FRONTEND
  # ══════════════════════════════════════════════════════════════════════════════

  frontend-test:
    name: Frontend — Unit Tests (Vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Run unit tests
        run: npm test

  frontend-lint:
    name: Frontend — Code Style (ESLint + React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Check code style
        run: npm run lint

  frontend-quality:
    name: Frontend — Code Quality (SonarJS)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Analyze code quality
        run: npm run lint:quality

  # ══════════════════════════════════════════════════════════════════════════════
  # E2E
  # ══════════════════════════════════════════════════════════════════════════════

  e2e-test:
    name: E2E — Playwright (Chromium)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install root dependencies (Playwright)
        run: npm ci

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright tests
        run: npx playwright test
        env:
          MONGO_URI: mongodb://localhost:27017/inkwell_e2e
          JWT_SECRET: ci-e2e-secret-key
          PORT: 5000
          NODE_ENV: test

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # ══════════════════════════════════════════════════════════════════════════════
  # SELENIUM WEBDRIVER  (Page Object pattern, Node.js / Mocha)
  # ══════════════════════════════════════════════════════════════════════════════

  selenium-test:
    name: E2E — Selenium WebDriver (Chrome headless)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Selenium test dependencies
        run: npm install
        working-directory: selenium

      - name: Start backend server
        run: node server.js &
        working-directory: backend
        env:
          MONGO_URI: mongodb://localhost:27017/inkwell_selenium
          JWT_SECRET: ci-selenium-secret-key
          PORT: 5000
          NODE_ENV: test

      - name: Start frontend dev server
        run: npm run dev &
        working-directory: frontend

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for backend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5000/api/posts && break || sleep 2; done
          echo "Waiting for frontend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5173 && break || sleep 2; done

      - name: Seed test user via API
        run: |
          curl -sf -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"name":"usenko","email":"usenko.0265@gmail.com","password":"654321"}' || true

      - name: Seed test post via API
        run: |
          TOKEN=$(curl -sf -X POST http://localhost:5000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"usenko.0265@gmail.com","password":"654321"}' \
            | node -e "process.stdin.resume();let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>console.log(JSON.parse(d).token))")
          curl -sf -X POST http://localhost:5000/api/posts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"title":"Seed Post","description":"Seed","body":"Seed post for comment test"}' || true

      - name: Run Selenium tests
        run: npm test
        working-directory: selenium
        env:
          HEADLESS: 'true'
          BASE_URL: 'http://localhost:5173'

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: selenium-screenshots
          path: selenium/screenshots/
          retention-days: 30

  # ══════════════════════════════════════════════════════════════════════════════
  # ROBOT FRAMEWORK  (Keyword Driven Testing)
  # ══════════════════════════════════════════════════════════════════════════════

  robot-kdt-test:
    name: E2E — Robot Framework KDT (Chrome headless)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: robot/requirements.txt

      - name: Install Python dependencies
        run: pip install -r robot/requirements.txt

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Start backend server
        run: node server.js &
        working-directory: backend
        env:
          MONGO_URI: mongodb://localhost:27017/inkwell_robot
          JWT_SECRET: ci-robot-secret-key
          PORT: 5000
          NODE_ENV: test

      - name: Start frontend dev server
        run: npm run dev &
        working-directory: frontend

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for backend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5000/api/posts && break || sleep 2; done
          echo "Waiting for frontend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5173 && break || sleep 2; done

      - name: Seed test user via API
        run: |
          curl -sf -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"name":"usenko","email":"usenko.0265@gmail.com","password":"654321"}' || true

      - name: Run Robot Framework tests
        run: |
          robot \
            --variable BROWSER:headlesschrome \
            --outputdir robot/results \
            robot/tests/

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: robot-report
          path: robot/results/
          retention-days: 30

  # ══════════════════════════════════════════════════════════════════════════════
  # NEWMAN  (Postman collection – REST API contract tests)
  # ══════════════════════════════════════════════════════════════════════════════

  newman-api-test:
    name: API — Newman (Postman collection)
    runs-on: ubuntu-latest
    needs: [backend-test]

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install Newman and HTML reporter
        run: npm install
        working-directory: postman

      - name: Start backend server
        run: node server.js &
        working-directory: backend
        env:
          MONGO_URI: mongodb://localhost:27017/inkwell_newman
          JWT_SECRET: ci-newman-secret-key
          PORT: 5000
          NODE_ENV: test
          CLIENT_URL: http://localhost:5173

      - name: Wait for backend to be ready
        run: |
          echo "Waiting for backend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5000/api/posts && break || sleep 2; done

      - name: Run Newman API tests
        run: npm run test:ci
        working-directory: postman

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: newman-report
          path: postman/reports/
          retention-days: 30

  # ══════════════════════════════════════════════════════════════════════════════
  # CUCUMBER BDD  (Gherkin scenarios, Node.js / @cucumber/cucumber)
  # ══════════════════════════════════════════════════════════════════════════════

  cucumber-bdd-test:
    name: E2E — Cucumber BDD (Chrome headless)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install backend dependencies
        run: npm ci
        working-directory: backend

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Cucumber dependencies
        run: npm install
        working-directory: cucumber

      - name: Start backend server
        run: node server.js &
        working-directory: backend
        env:
          MONGO_URI: mongodb://localhost:27017/inkwell_cucumber
          JWT_SECRET: ci-cucumber-secret-key
          PORT: 5000
          NODE_ENV: test

      - name: Start frontend dev server
        run: npm run dev &
        working-directory: frontend

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for backend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5000/api/posts && break || sleep 2; done
          echo "Waiting for frontend..."
          for i in $(seq 1 30); do curl -sf http://localhost:5173 && break || sleep 2; done

      - name: Seed test user via API
        run: |
          curl -sf -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"name":"usenko","email":"usenko.0265@gmail.com","password":"654321"}' || true

      - name: Seed test post via API
        run: |
          TOKEN=$(curl -sf -X POST http://localhost:5000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"usenko.0265@gmail.com","password":"654321"}' \
            | node -e "process.stdin.resume();let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>console.log(JSON.parse(d).token))")
          curl -sf -X POST http://localhost:5000/api/posts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"title":"Seed Post","description":"Seed","body":"Seed post for comment test"}' || true

      - name: Run Cucumber BDD tests
        run: npm test
        working-directory: cucumber
        env:
          HEADLESS: 'true'
          BASE_URL: 'http://localhost:5173'

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: cucumber-report
          path: cucumber/reports/
          retention-days: 30
